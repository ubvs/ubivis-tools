name: Deploy Secrets (Infisical)

on:
  push:
    branches:
      - main
    paths:
      - 'apps/secrets/**'
      - '.github/workflows/deploy-secrets.yml'

jobs:
  deploy:
    name: Deploy to Coolify and Configure Caddy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Coolify deployment
        env:
          COOLIFY_DEPLOY_URL: ${{ secrets.COOLIFY_DEPLOY_URL }}
          COOLIFY_API_TOKEN: ${{ secrets.COOLIFY_API_TOKEN }}
        run: |
          echo "üöÄ Triggering Coolify deployment..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$COOLIFY_DEPLOY_URL" \
            -H "Authorization: Bearer $COOLIFY_API_TOKEN")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            echo "‚úÖ Coolify deployment triggered successfully (HTTP $RESPONSE)"
          else
            echo "‚ùå Failed to trigger deployment (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Wait for deployment to complete
        run: |
          echo "‚è≥ Waiting 60 seconds for Coolify to deploy..."
          sleep 60

      - name: Configure Caddy reverse proxy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SECRETS_SERVER_SSH_KEY }}
          SERVER_IP: ${{ secrets.SECRETS_SERVER_IP }}
        run: |
          echo "üîß Configuring Caddy on production server..."
          
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null
          
          # Run Caddy configuration script
          ssh -o StrictHostKeyChecking=no root@$SERVER_IP \
            'bash -c "$(curl -fsSL https://raw.githubusercontent.com/ubvs/ubivis-tools/main/apps/secrets/deploy-caddy-config.sh)"'
          
          echo "‚úÖ Caddy configuration complete"

      - name: Verify deployment
        env:
          DOMAIN: ubivis-secrets.ideasnet.app
        run: |
          echo "üîç Verifying deployment..."
          sleep 10
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN)
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Deployment successful! https://$DOMAIN is responding"
          else
            echo "‚ö†Ô∏è  Warning: https://$DOMAIN returned HTTP $RESPONSE"
            echo "   (This might be expected if the app requires setup)"
          fi
